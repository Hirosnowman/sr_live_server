<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>SR コメント・ギフト 3カラム（最新上）</title>
<style>
body { font-family: sans-serif; margin: 10px; background:#f0f0f0; }
.container { display: flex; gap: 10px; }

/* 各カラム */
.column {
    flex: 1;
    border: 1px solid #ccc;
    background: #fff;
    padding: 5px;
    max-height: 600px;
    overflow-y: auto;
}

/* コメント */
#comment div { display: flex; align-items: center; margin-bottom: 5px; }
#comment img { width: 40px; height: 40px; margin-right: 5px; }

/* ギフト */
.giftItem { display: flex; align-items: center; background: #f9f9f9; padding: 2px 5px; border-radius: 5px; margin-bottom: 5px; box-shadow: 1px 1px 3px #aaa; }
.giftItem img { width: 40px; height: 40px; margin-right: 5px; }

/* カラムヘッダー */
.column h2 { text-align: center; margin: 5px 0; font-size: 1.2em; }
</style>
</head>
<body>

<div class="container">
    <div class="column">
        <h2>コメント</h2>
        <div id="comment"></div>
    </div>
    <div class="column">
        <h2>有料ギフト</h2>
        <div id="paidGift"></div>
    </div>
    <div class="column">
        <h2>無料ギフト</h2>
        <div id="freeGift"></div>
    </div>
</div>

<script>
const roomId = 490133; // ←対象のルームID
let broadcastKey = null;
let socket = null;

// broadcast_key 取得
async function fetchBroadcastKey() {
    try {
        const res = await fetch(`/get_broadcast_key?room_id=${roomId}`);
        const json = await res.json();
        if (json.broadcast_key) return json.broadcast_key;
        else return null;
    } catch(e) {
        console.error("broadcast_key fetch error:", e);
        return null;
    }
}

// WebSocket 接続
function connectWebSocket(key) {
    socket = new WebSocket("wss://online.showroom-live.com");
    socket.onopen = () => { socket.send("SUB\t" + key); console.log("WebSocket connected:", key); };
    socket.onmessage = (msg) => {
        const data = msg.data;
        if (data.startsWith("ACK") || data.startsWith("ERR")) return;
        const jsonText = data.replace(`MSG\t${key}`, "");
        const obj = JSON.parse(jsonText);

        if (obj.cm !== undefined) showComment(obj);
        else if (obj.g !== undefined) showGift(obj); // gtで判定して振り分け
    };
    socket.onclose = () => { console.log("WebSocket closed, waiting to reconnect..."); };
}

// コメント表示（最新上）
function showComment(c) {
    const div = document.createElement("div");
    const img = document.createElement("img");
    img.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${c.av}.png`;
    const p = document.createElement("p");
    p.textContent = `${c.ac}：${c.cm}`;
    div.appendChild(img);
    div.appendChild(p);

    const commentBox = document.getElementById("comment");
    commentBox.prepend(div);  // ← prependで最新上
}

// ギフト表示（gtで無料/有料振り分け、最新上）
function showGift(g) {
    const gt = parseInt(g.gt);
    let containerId;
    if(gt === 1) containerId = "paidGift";  // 中央
    else if(gt === 2) containerId = "freeGift";  // 右
    else return;

    const div = document.createElement("div");
    div.className = "giftItem";

    const img1 = document.createElement("img");
    img1.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${g.av}.png`;

    const img2 = document.createElement("img");
    img2.src = `https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`;
    img2.width = 30;

    const p = document.createElement("p");
    p.textContent = `${g.ac}：${g.n}個`;

    div.appendChild(img1);
    div.appendChild(img2);
    div.appendChild(p);

    const box = document.getElementById(containerId);
    box.prepend(div);  // ← prependで最新上
}

// 自動再取得＋WebSocketループ
async function autoConnect() {
    while(true) {
        const key = await fetchBroadcastKey();
        if (key && key !== broadcastKey) {
            broadcastKey = key;
            if(socket) socket.close();
            connectWebSocket(broadcastKey);
        }
        await new Promise(r => setTimeout(r, 5000)); // 5秒ごと
    }
}

// 起動
autoConnect();
</script>

</body>
</html>
