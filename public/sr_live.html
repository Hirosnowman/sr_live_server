<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>SR コメント・ギフト 3カラム + ルーム切替</title>
<style>
body { font-family: sans-serif; margin: 10px; background:#f0f0f0; }
header { margin-bottom: 10px; }
input { padding: 5px; font-size: 1em; width: 120px; }
button { padding: 5px 10px; font-size: 1em; }

.container { display: flex; gap: 10px; }

/* 各カラム */
.column {
    flex: 1;
    border: 1px solid #ccc;
    background: #fff;
    padding: 5px;
    max-height: 600px;
    overflow-y: auto;
}

/* コメント */
#comment div { display: flex; align-items: center; margin-bottom: 5px; }
#comment img { width: 40px; height: 40px; margin-right: 5px; }

/* ギフト */
.giftItem { display: flex; align-items: center; background: #f9f9f9; padding: 2px 5px; border-radius: 5px; margin-bottom: 5px; box-shadow: 1px 1px 3px #aaa; }
.giftItem img { width: 40px; height: 40px; margin-right: 5px; }

/* カラムヘッダー */
.column h2 { text-align: center; margin: 5px 0; font-size: 1.2em; }
</style>
</head>
<body>

<header>
    <label>Room ID: <input type="text" id="roomInput" placeholder="例: 490133"></label>
    <button id="switchRoom">表示切替</button>
</header>

<div class="container">
    <div class="column">
        <h2>コメント</h2>
        <div id="comment"></div>
    </div>
    <div class="column">
        <h2>有料ギフト</h2>
        <div id="paidGift"></div>
    </div>
    <div class="column">
        <h2>無料ギフト</h2>
        <div id="freeGift"></div>
    </div>
</div>

<script>
let broadcastKey = null;
let socket = null;

// コメント表示（最新上から下へ）
function showComment(c) {
    const div = document.createElement("div");
    const img = document.createElement("img");
    img.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${c.av}.png`;
    const p = document.createElement("p");
    p.textContent = `${c.ac}：${c.cm}`;
    div.appendChild(img);
    div.appendChild(p);
    const commentBox = document.getElementById("comment");
    commentBox.prepend(div); // 最新を上に表示
}


// ギフト表示（gtで無料/有料振り分け、最新上）
function showGift(g) {
    const gt = parseInt(g.gt);
    let containerId;
    if(gt === 1) containerId = "paidGift";  // 中央
    else if(gt === 2) containerId = "freeGift";  // 右
    else return;

    const div = document.createElement("div");
    div.className = "giftItem";

    const img1 = document.createElement("img");
    img1.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${g.av}.png`;

    const img2 = document.createElement("img");
    img2.src = `https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`;
    img2.width = 30;

    const p = document.createElement("p");
    p.textContent = `${g.ac}：${g.n}個`;

    div.appendChild(img1);
    div.appendChild(img2);
    div.appendChild(p);

    const box = document.getElementById(containerId);
    box.prepend(div);  // ← prependで最新上
}

// WebSocket 接続
async function connectRoom(roomId) {
    try {
        const res = await fetch(`/get_broadcast_key?room_id=${roomId}`);
        const json = await res.json();
        if (!json.broadcast_key) { alert("broadcast_key取得失敗"); return; }

        broadcastKey = json.broadcast_key;

        if (socket) socket.close();

        socket = new WebSocket("wss://online.showroom-live.com");
        socket.onopen = () => socket.send("SUB\t" + broadcastKey);
        socket.onmessage = (msg) => {
            const data = msg.data;
            if (data.startsWith("ACK") || data.startsWith("ERR")) return;
            const obj = JSON.parse(data.replace(`MSG\t${broadcastKey}`, ""));
            if (obj.cm) showComment(obj);
            else if (obj.g) showGift(obj);
        };

        // UIリセット
        document.getElementById("comment").innerHTML = "";
        document.getElementById("paidGift").innerHTML = "";
        document.getElementById("freeGift").innerHTML = "";

    } catch(e) {
        console.error(e);
        alert("broadcast_key取得中にエラー");
    }
}

// ボタン押下でルーム切替
document.getElementById("switchRoom").onclick = () => {
    const newRoomId = document.getElementById("roomInput").value.trim();
    if (newRoomId) connectRoom(newRoomId);
};

// 初期ルーム
connectRoom(490133);
</script>

</body>
</html>
