<!-- public/index.html -->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>SR コメント・ギフト 3ブロック</title>
<style>
/* 既存の3ブロック表示スタイルをここに統合 */
</style>
</head>
<body>
<header>
    RoomID: <input id="roomInput" placeholder="例:490133">
    <button id="switchRoom">接続/切替</button>
    <span id="statusText">Status: 待機中</span>
</header>

<div class="container">
    <div class="column"><h2>コメント</h2><div id="commentList"></div></div>
    <div class="column"><h2>有料ギフト</h2><div id="paidGiftList"></div></div>
    <div class="column"><h2>無料ギフト</h2><div id="freeGiftList"></div></div>
</div>

<script>
let socket = null;
let currentRoom = "";
let receivedComments = new Set();
let receivedGifts = new Set();

function setStatus(text,color){const el=document.getElementById("statusText");el.textContent="Status: "+text;el.style.color=color;}

function connectRoom(roomId){
    currentRoom = roomId;
    setStatus("再接続中","blue");
    if(socket) socket.close();

    socket = new WebSocket("ws://localhost:8080"); // Node.jsサーバーに接続
    socket.onopen = ()=>{
        setStatus("正常接続中","green");
        socket.send(JSON.stringify({room_id: roomId}));
    };
    socket.onmessage = e=>{
        const obj = JSON.parse(e.data);
        if(obj.type==="comment_log"||obj.type==="gift_log") obj.data.forEach(item=>{
            if(obj.type==="comment_log") appendComment(item);
            else appendGift(item);
        });
        else if(obj.type==="comment") appendComment(obj.data);
        else if(obj.type==="gift") appendGift(obj.data);
    };
    socket.onclose = ()=>{setStatus("切断","red");setTimeout(()=>connectRoom(currentRoom),3000);}
}

function appendComment(c){
    const key = `${c.time}_${c.ac}_${c.cm}`;
    if(receivedComments.has(key)) return; receivedComments.add(key);
    const div=document.createElement("div"); div.className="commentItem";
    const img=document.createElement("img"); img.src=`https://image.showroom-cdn.com/showroom-prod/image/avatar/${c.av}.png`;
    const p=document.createElement("p"); p.textContent=`[${c.time}] ${c.ac}: ${c.cm || c.comment || ''}`;
    div.appendChild(img); div.appendChild(p);
    document.getElementById("commentList").appendChild(div); div.scrollIntoView({behavior:"smooth"});
}

function appendGift(g){
    const key=`${g.time}_${g.ac}_${g.g}`; if(receivedGifts.has(key)) return; receivedGifts.add(key);
    const div=document.createElement("div"); div.className="giftItem";
    const img1=document.createElement("img"); img1.src=`https://image.showroom-cdn.com/showroom-prod/image/avatar/${g.av}.png`;
    const img2=document.createElement("img"); img2.src=`https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`;
    const p=document.createElement("p"); p.textContent=`[${g.time}] ${g.ac}: x${g.n}`;
    if(g.gt==1) document.getElementById("paidGiftList").appendChild(div);
    else if(g.gt==2) document.getElementById("freeGiftList").appendChild(div);
    div.appendChild(img1); div.appendChild(img2); div.appendChild(p); div.scrollIntoView({behavior:"smooth"});
}

document.getElementById("switchRoom").onclick=()=>{
    const rid=document.getElementById("roomInput").value.trim();
    if(rid) connectRoom(rid);
};
</script>
</body>
</html>
