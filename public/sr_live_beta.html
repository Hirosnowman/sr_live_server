<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>SR コメント・ギフト 3カラム + 設定パネル</title>
<style>
body { font-family: sans-serif; margin: 0; background:#f0f0f0; }
header { position: fixed; top:0; left:0; width:100%; background:#ddd; padding:5px 10px; z-index:100; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
input { padding: 3px; font-size: 1em; width: 100px; }
button { padding: 3px 8px; font-size: 1em; }
.container { display:flex; gap:10px; margin-top:60px; padding:10px; }

.column {
    flex:1;
    border:1px solid #ccc;
    background:#fff;
    padding:5px;
    max-height:600px;
    overflow-y:auto;
}

#comment div { display:flex; align-items:center; margin-bottom:5px; }
#comment img { width:40px; height:40px; margin-right:5px; }

.giftItem { display:flex; align-items:center; background:#f9f9f9; padding:2px 5px; border-radius:5px; margin-bottom:5px; box-shadow:1px 1px 3px #aaa; }
.giftItem img { width:40px; height:40px; margin-right:5px; }

.column h2 { text-align:center; margin:5px 0; font-size:1.2em; }

#settingsPanel { display:none; position:absolute; right:10px; top:40px; background:#fff; border:1px solid #ccc; padding:5px; z-index:200; font-size:0.9em; }
#settingsPanel div { margin-bottom:5px; }
</style>
</head>
<body>

<header>
  <label>Room ID: <input type="text" id="roomInput" placeholder="例: 490133"></label>
  <button id="switchRoom">表示切替</button>
  <span id="statusSpan">Status: 待機中</span>
  <span id="hbSpan">HB: 10s</span>
  <span id="kpSpan">KeyPoll: 5s</span>
  <span id="roomNameSpan">Room: -</span>
  <span id="startedSpan">開始: -</span>
  <span id="elapsedSpan">経過: -</span>

  <button id="toggleSettings" style="position:absolute; right:10px; top:5px;">設定</button>

  <div id="settingsPanel">
    <div><strong>コメント:</strong> 文字サイズ <input type="number" id="commentFontSize" value="14" min="10" max="30"> px
      色 <input type="color" id="commentColor" value="#000000"></div>
    <div><strong>有料ギフト:</strong> 文字サイズ <input type="number" id="paidFontSize" value="14" min="10" max="30"> px
      色 <input type="color" id="paidColor" value="#000000"></div>
    <div><strong>無料ギフト:</strong> 文字サイズ <input type="number" id="freeFontSize" value="14" min="10" max="30"> px
      色 <input type="color" id="freeColor" value="#000000"></div>
    <button id="applyDisplaySettings">適用</button>
  </div>
</header>

<div class="container">
    <div class="column">
        <h2>コメント</h2>
        <div id="comment"></div>
    </div>
    <div class="column">
        <h2>有料ギフト</h2>
        <div id="paidGift"></div>
    </div>
    <div class="column">
        <h2>無料ギフト</h2>
        <div id="freeGift"></div>
    </div>
</div>

<script>
let broadcastKey = null;
let socket = null;
let startedAt = null;

let commentSettings = {size:14, color:"#000000"};
let paidSettings = {size:14, color:"#000000"};
let freeSettings = {size:14, color:"#000000"};

// WebSocketコメントバッファ（最新50件）
let wsCommentBuffer = [];
function pushWsComment(c){
    wsCommentBuffer.unshift({
        id: c.cid || null,
        text: c.cm,
        user: c.ac,
        ts: Date.now()
    });
    if(wsCommentBuffer.length > 50) wsCommentBuffer.pop();
}

// 設定パネル
const settingsPanel = document.getElementById("settingsPanel");
document.getElementById("toggleSettings").onclick = ()=>{
    settingsPanel.style.display = (settingsPanel.style.display==="none")?"block":"none";
};

// 設定適用
document.getElementById("applyDisplaySettings").onclick = () => {
    commentSettings.size = parseInt(document.getElementById("commentFontSize").value);
    commentSettings.color = document.getElementById("commentColor").value;
    paidSettings.size = parseInt(document.getElementById("paidFontSize").value);
    paidSettings.color = document.getElementById("paidColor").value;
    freeSettings.size = parseInt(document.getElementById("freeFontSize").value);
    freeSettings.color = document.getElementById("freeColor").value;

    document.getElementById("comment").style.fontSize = commentSettings.size+"px";
    document.getElementById("comment").style.color = commentSettings.color;
    document.getElementById("paidGift").style.fontSize = paidSettings.size+"px";
    document.getElementById("paidGift").style.color = paidSettings.color;
    document.getElementById("freeGift").style.fontSize = freeSettings.size+"px";
    document.getElementById("freeGift").style.color = freeSettings.color;
};

// コメント表示
function showComment(c) {
    const div = document.createElement("div");
    const img = document.createElement("img");
    img.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${c.av}.png`;
    const p = document.createElement("p");
    p.textContent = `${c.ac}：${c.cm}`;
    div.appendChild(img);
    div.appendChild(p);
    document.getElementById("comment").prepend(div);
}

// 補完コメント表示（★補完★）
function showComplementComment(c){
    const div = document.createElement("div");
    const img = document.createElement("img");
    img.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${c.av}.png`;
    const p = document.createElement("p");
    p.textContent = `★補完★ ${c.ac}：${c.cm}`;
    p.style.color = "#AA0000";
    div.appendChild(img);
    div.appendChild(p);
    document.getElementById("comment").prepend(div);
}

// ギフト表示（累積）
const paidGiftMap = {};
const freeGiftMap = {};
function showGift(g) {
    const gt = parseInt(g.gt);
    let containerId, giftMap;
    if(gt===2){ containerId="freeGift"; giftMap=freeGiftMap; }
    else { containerId="paidGift"; giftMap=paidGiftMap; }

    const key = `${g.u}_${g.g}`;
    if(giftMap[key]){
        giftMap[key].count += g.n;
        giftMap[key].time = Date.now();
        giftMap[key].div.querySelector("p").textContent = `${g.ac}：${giftMap[key].count}個`;
        return;
    }

    const div = document.createElement("div");
    div.className="giftItem";
    const img1 = document.createElement("img");
    img1.src=`https://image.showroom-cdn.com/showroom-prod/image/avatar/${g.av}.png`;
    const img2 = document.createElement("img");
    img2.src=`https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`;
    img2.width=30;
    const p = document.createElement("p");
    p.textContent=`${g.ac}：${g.n}個`;
    div.appendChild(img1); div.appendChild(img2); div.appendChild(p);
    document.getElementById(containerId).prepend(div);
    giftMap[key]={div:div, count:g.n, time:Date.now()};
}

// WebSocket 接続
async function connectRoom(roomId) {
    try{
        const res = await fetch(`/get_broadcast_key?room_id=${roomId}`);
        const json = await res.json();
        if(!json.broadcast_key){ alert("broadcast_key取得失敗"); return; }
        broadcastKey=json.broadcast_key;

        if(socket) socket.close();

        socket = new WebSocket("wss://online.showroom-live.com");
        socket.onopen = ()=>{
            socket.send("SUB\t"+broadcastKey);
            document.getElementById("statusSpan").textContent="Status: 接続中";
        };
        socket.onmessage=(msg)=>{
            const data = msg.data;
            if(data.startsWith("ACK")||data.startsWith("ERR")) return;
            const obj = JSON.parse(data.replace(`MSG\t${broadcastKey}`,""));
            
            if(obj.cm){
                showComment(obj);
                pushWsComment(obj);
            }
            else if(obj.g){
                showGift(obj);
            }

            if(!startedAt && obj.started_at) startedAt = obj.started_at*1000;
            if(obj.main_name) document.getElementById("roomNameSpan").textContent="Room: "+obj.main_name;
        };
        socket.onclose = ()=>{ document.getElementById("statusSpan").textContent="Status: 切断"; };

        // リセット
        document.getElementById("comment").innerHTML="";
        document.getElementById("paidGift").innerHTML="";
        document.getElementById("freeGift").innerHTML="";
        wsCommentBuffer = [];
        Object.keys(paidGiftMap).forEach(k=>delete paidGiftMap[k]);
        Object.keys(freeGiftMap).forEach(k=>delete freeGiftMap[k]);

    }catch(e){
        console.error(e);
        alert("broadcast_key取得中にエラー");
    }
}

// コメント補完処理
async function checkMissingComments(roomId){
    try{
        const res = await fetch(`https://www.showroom-live.com/api/live/comment_log?room_id=${roomId}`);
        const logs = await res.json();
        if(!Array.isArray(logs)) return;

        const latest = logs.slice(-10);

        latest.forEach(log => {
            const exists = wsCommentBuffer.some(ws => {
                if(ws.id && log.comment_id && ws.id === log.comment_id) return true;
                if(ws.text === log.comment && ws.user === log.name) return true;
                return false;
            });

            if(!exists){
                const c = { ac: log.name, cm: log.comment, av: log.avatar_id || "0" };
                showComplementComment(c);
                pushWsComment({ cid: log.comment_id, cm: log.comment, ac: log.name });
            }
        });

    }catch(e){
        console.error("log check failed", e);
    }
}

// 10秒おきに補完チェック
setInterval(()=>{
    const roomId = document.getElementById("roomInput").value.trim();
    if(roomId) checkMissingComments(roomId);
}, 10000);

// ルーム切替
document.getElementById("switchRoom").onclick = ()=>{
    const newRoomId=document.getElementById("roomInput").value.trim();
    if(newRoomId) connectRoom(newRoomId);
};

// 経過時間更新
setInterval(()=>{
    if(startedAt){
        const now=Date.now();
        const diff=Math.floor((now-startedAt)/1000);
        const h=Math.floor(diff/3600);
        const m=Math.floor((diff%3600)/60);
        const s=diff%60;
        document.getElementById("startedSpan").textContent="開始: "+new Date(startedAt).toLocaleString();
        document.getElementById("elapsedSpan").textContent=`経過: ${h}時間 ${m}分 ${s}秒`;
    }
},1000);

// 初期ルーム
connectRoom(490133);
</script>
</body>
</html>
