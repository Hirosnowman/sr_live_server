<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>SR コメント・ギフト 3カラム + ヘッダー固定</title>
<style>
body { font-family: sans-serif; margin:0; background:#f0f0f0; }
header {
    position: fixed;
    top:0; left:0; right:0;
    height: 50px;
    background:#333; color:#fff;
    display:flex; align-items:center; padding:0 10px;
    font-size:14px; z-index:100;
}
header div { margin-right:15px; }

.main-container {
    display: flex; gap:10px;
    margin-top:60px; /* ヘッダー分 */
    padding:5px;
}

/* ボックス共通 */
.box {
    border:1px solid #ccc; background:#fff;
    padding:5px;
    overflow-y:auto;
    flex:1;
    max-height:600px;
    resize:both; 
}

/* コメント */
#comment div { display:flex; align-items:center; margin-bottom:5px; }
#comment img { width:40px;height:40px;margin-right:5px; }

/* ギフト */
.giftItem { display:flex; align-items:center; background:#f9f9f9; padding:2px 5px; border-radius:5px; margin-bottom:5px; box-shadow:1px 1px 3px #aaa; }
.giftItem img { width:40px; height:40px; margin-right:5px; }

/* ヘッダーラベル */
header span.label { font-weight:bold; margin-right:3px; }
</style>
</head>
<body>

<header>
    <div><span class="label">Status:</span><span id="status">待機中</span></div>
    <div><span class="label">HB:</span><span id="hbInterval">10s</span></div>
    <div><span class="label">KeyPoll:</span><span id="keyPollInterval">5s</span></div>
    <div><span class="label">Room:</span><span id="roomName">---</span></div>
    <div><span class="label">配信開始:</span><span id="startedAt">---</span></div>
    <div><span class="label">経過:</span><span id="elapsed">0分</span></div>
</header>

<div class="main-container">
    <div class="box" id="commentBox">
        <h2>コメント</h2>
        <div id="comment"></div>
    </div>
    <div class="box" id="paidGiftBox">
        <h2>有料ギフト</h2>
        <div id="paidGift"></div>
    </div>
    <div class="box" id="freeGiftBox">
        <h2>無料ギフト</h2>
        <div id="freeGift"></div>
    </div>
</div>

<script>
let broadcastKey = null;
let socket = null;
let startedAtUnix = null;
let mainName = "";
let cumulativePaid = {};
let cumulativeFree = {};
const HB_INTERVAL = 10000; // 10秒
const KEY_POLL_INTERVAL = 5000; // 5秒

// 経過時間更新
function updateElapsed() {
    if(!startedAtUnix) return;
    const now = Math.floor(Date.now()/1000);
    const diff = now - startedAtUnix;
    const h = Math.floor(diff/3600);
    const m = Math.floor((diff%3600)/60);
    document.getElementById("elapsed").textContent = `${h}時間${m}分`;
}
setInterval(updateElapsed, 1000);

// コメント表示
function showComment(c){
    const div = document.createElement("div");
    const img = document.createElement("img");
    img.src = `https://image.showroom-cdn.com/showroom-prod/image/avatar/${c.av}.png`;
    const p = document.createElement("p");
    p.textContent = `${c.ac}：${c.cm}`;
    div.appendChild(img); div.appendChild(p);
    document.getElementById("comment").prepend(div);
}

// ギフト累積表示
function showGift(g){
    const gt = parseInt(g.gt);
    let containerId, cumulative;
    if(gt===1){ containerId="paidGift"; cumulative=cumulativePaid; }
    else if(gt===2){ containerId="freeGift"; cumulative=cumulativeFree; }
    else return;

    const key = g.u+"_"+g.g;
    cumulative[key] = cumulative[key]||{ac:g.ac,n:0,av:g.av};
    cumulative[key].n += g.n;

    // 更新
    const box = document.getElementById(containerId);
    let div = box.querySelector(`#${key}`);
    if(!div){
        div = document.createElement("div"); div.id=key; div.className="giftItem";
        const img1=document.createElement("img"); img1.src=`https://image.showroom-cdn.com/showroom-prod/image/avatar/${g.av}.png`;
        const img2=document.createElement("img"); img2.src=`https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`; img2.width=30;
        const p=document.createElement("p"); div.appendChild(img1); div.appendChild(img2); div.appendChild(p);
        box.prepend(div);
    }
    div.querySelector("p").textContent=`${cumulative[key].ac}：${cumulative[key].n}個`;
}

// broadcast_key取得
async function fetchBroadcastKey(roomId){
    try{
        const res = await fetch(`/get_broadcast_key?room_id=${roomId}`);
        const json = await res.json();
        return json.broadcast_key || null;
    }catch(e){ console.error(e); return null;}
}

// 配信情報取得
async function fetchLiveInfo(roomId){
    try{
        const res = await fetch(`/get_live_info?room_id=${roomId}`);
        const json = await res.json();
        if(json.live_status!==2){ document.getElementById("status").textContent="待機中"; return null;}
        startedAtUnix = json.started_at || Math.floor(Date.now()/1000);
        mainName = json.main_name || "---";
        document.getElementById("roomName").textContent = mainName;
        document.getElementById("startedAt").textContent = new Date(startedAtUnix*1000).toLocaleString();
        document.getElementById("status").textContent="接続中";
        return json.bcsvr_key;
    }catch(e){ console.error(e); return null;}
}

// WebSocket接続
async function connectRoom(roomId){
    let key = await fetchLiveInfo(roomId);
    if(!key) return;
    if(socket) socket.close();
    broadcastKey=key;
    socket=new WebSocket("wss://online.showroom-live.com");
    socket.onopen=()=>socket.send("SUB\t"+broadcastKey);
    socket.onmessage=(msg)=>{
        const data = msg.data;
        if(data.startsWith("ACK")||data.startsWith("ERR")) return;
        const obj = JSON.parse(data.replace(`MSG\t${broadcastKey}`,""));
        if(obj.cm) showComment(obj);
        else if(obj.g) showGift(obj);
    };
}

// 初期ルーム
connectRoom(490133);
</script>
</body>
</html>
