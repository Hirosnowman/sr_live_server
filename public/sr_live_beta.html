<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>SR コメント・ギフト 3カラム + ヘッダー情報</title>
<style>
body { font-family: sans-serif; margin: 0; background:#f0f0f0; }
header { position: sticky; top: 0; background: #fff; padding: 5px 10px; border-bottom: 1px solid #ccc; z-index: 10; display:flex; align-items:center; gap:20px; }
.container { display: flex; gap: 10px; padding: 10px; }
.column { flex:1; border:1px solid #ccc; background:#fff; padding:5px; max-height:600px; overflow-y:auto; }
#comment div, .giftItem { display:flex; align-items:center; margin-bottom:5px; }
#comment img, .giftItem img { width:40px; height:40px; margin-right:5px; }
.giftItem { background:#f9f9f9; padding:2px 5px; border-radius:5px; box-shadow:1px 1px 3px #aaa; }
.column h2 { text-align:center; margin:5px 0; font-size:1.2em; }
</style>
</head>
<body>

<header>
    <span id="status">Status: 待機中</span>
    <span id="hb">HB: 10s</span>
    <span id="keyPoll">KeyPoll: 5s</span>
    <span id="roomName">Room: -</span>
    <span id="startedAt">開始: -</span>
    <span id="elapsedTime">経過: -</span>
    <label>Room ID: <input type="text" id="roomInput" placeholder="例: 490133"></label>
    <button id="switchRoom">切替</button>
</header>

<div class="container">
    <div class="column">
        <h2>コメント</h2>
        <div id="comment"></div>
    </div>
    <div class="column">
        <h2>有料ギフト</h2>
        <div id="paidGift"></div>
    </div>
    <div class="column">
        <h2>無料ギフト</h2>
        <div id="freeGift"></div>
    </div>
</div>

<script>
let broadcastKey = null;
let socket = null;
let startedAtSec = null; // 秒単位
let roomName = "-";

// コメント表示
function showComment(c){
    const div=document.createElement("div");
    const img=document.createElement("img");
    img.src=`https://image.showroom-cdn.com/showroom-prod/image/avatar/${c.av}.png`;
    const p=document.createElement("p");
    p.textContent=`${c.ac}：${c.cm}`;
    div.appendChild(img); div.appendChild(p);
    document.getElementById("comment").prepend(div);
}

// ギフト表示
function showGift(g){
    const gt = parseInt(g.gt);
    let containerId = gt===2 ? "freeGift" : "paidGift";
    const div=document.createElement("div");
    div.className="giftItem";
    const img1=document.createElement("img");
    img1.src=`https://image.showroom-cdn.com/showroom-prod/image/avatar/${g.av}.png`;
    const img2=document.createElement("img");
    img2.src=`https://static.showroom-live.com/image/gift/${g.g}_s.png?v=7`;
    img2.width=30;
    const p=document.createElement("p");
    p.textContent=`${g.ac}：${g.n}個`;
    div.appendChild(img1); div.appendChild(img2); div.appendChild(p);
    document.getElementById(containerId).prepend(div);
}

// 経過時間更新
function updateElapsed(){
    if(startedAtSec){
        const diffSec=Math.floor(Date.now()/1000 - startedAtSec);
        const h=Math.floor(diffSec/3600);
        const m=Math.floor((diffSec%3600)/60);
        document.getElementById("elapsedTime").textContent=`経過: ${h}時間${m}分`;
    }
}
setInterval(updateElapsed, 60000); // 1分ごと更新

// WebSocket 接続
async function connectRoom(roomId){
    try{
        document.getElementById("status").textContent="Status: 接続中";
        const res=await fetch(`/get_broadcast_key?room_id=${roomId}`);
        const json=await res.json();
        if(!json.broadcast_key){ alert("broadcast_key取得失敗"); return; }

        broadcastKey=json.broadcast_key;
        startedAtSec=json.started_at; // APIで取得する配信開始 unixtime 秒
        roomName=json.main_name || "-";

        document.getElementById("roomName").textContent=`Room: ${roomName}`;
        document.getElementById("startedAt").textContent=`開始: ${new Date(startedAtSec*1000).toLocaleString()}`;

        if(socket) socket.close();
        socket=new WebSocket("wss://online.showroom-live.com");
        socket.onopen=()=>socket.send("SUB\t"+broadcastKey);
        socket.onmessage=(msg)=>{
            const data=msg.data;
            if(data.startsWith("ACK")||data.startsWith("ERR")) return;
            const obj=JSON.parse(data.replace(`MSG\t${broadcastKey}`,""));
            if(obj.cm) showComment(obj);
            else if(obj.g) showGift(obj);
        };

        // UIリセット
        document.getElementById("comment").innerHTML="";
        document.getElementById("paidGift").innerHTML="";
        document.getElementById("freeGift").innerHTML="";

    } catch(e){
        console.error(e);
        document.getElementById("status").textContent="Status: エラー";
    }
}

// ルーム切替ボタン
document.getElementById("switchRoom").onclick=()=>{
    const newRoomId=document.getElementById("roomInput").value.trim();
    if(newRoomId) connectRoom(newRoomId);
};

// 初期ルーム
connectRoom(490133);
</script>

</body>
</html>
